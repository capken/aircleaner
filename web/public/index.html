<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>天朗气清</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="js/holder.js"></script>
  </head>
  <body>

    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12" id="search_bar"></div>
        <div class="col-xs-12" id="search_results"></div>
      </div>
    </div>

    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/backbone-min.js"></script>

    <script type="text/template" id="search_template">
      <div class="panel-group" id="accordion">
        <div class="panel panel-default">

          <div class="panel-heading">
            <h3 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">搜索条件: 上海, 25平米</a>
            </h3>
          </div>

          <div id="collapseOne" class="panel-collapse collapse in">
            <div class="panel-body">
              <form class="form-horizontal" role="form">
                <div class="form-group">
                  <label for="city_code" class="col-xs-3 control-label">所在城市</label>
                  <div class="col-xs-9">
                    <input type="text" class="form-control" id="city_code" placeholder="上海">
                  </div>
                </div>
                <div class="form-group">
                  <label for="room_size" class="col-xs-3 control-label">室内面积(平米)</label>
                  <div class="col-xs-9">
                    <input type="number" class="form-control" id="room_size" placeholder="25">
                  </div>
                </div>
                <button type="button" class="btn btn-primary btn-lg btn-block" id="search_button">搜索</button>
              </form>
            </div>
          </div>

        </div>
      </div>
    </script>

    <script type="text/template" id="results_template">
      <ul class="media-list">
        <% _.each(products, function (product) { %>
        <li class="media">
          <a class="pull-left" href="#">
            <img class="media-object" data-src="holder.js/80x60" alt="image">
          </a>
          <div class="media-body">
            <h4 class="media-heading"><%= product.get('brand') %> - <%= product.get('model') %></h4>
            CADR: <%= product.get('cadr_dust') %> m3/h
          </div>
        </li>
        <% }); %>
      </ul>
    </script>

    <script>

      var Products = Backbone.Collection.extend({
        url: function() {
          return '/suggest?room_size=' + this.room_size +
            "&page=" + this.page;
        },
        page: 1,
        room_size: 15,
        parse: function(resp, xhr) {
          return resp.products;
        }
      });

      var SearchView = Backbone.View.extend({
        initialize: function() {
          this.products = new Products();
          this.render();
        },
        render: function() {
          var template = _.template($("#search_template").html(), {});
          this.$el.html(template);
        },
        events: {
          "click button": "doSearch"
        },
        doSearch: function(event) {
          console.log("Search Button Clicked");
          this.products.room_size = $("#room_size").val();
          this.products.fetch({
            success: function(products) {
              var template = _.template(
                $("#results_template").html(),
                {products: products.models, _:_}
              );
              $("#search_results").append(template);
              Holder.run();
            }
          });
        }
      });

      var search_view = new SearchView({ el: $("#search_bar") })
      
//      var AppRouter = Backbone.Router.extend({
//        routes: {
//          "*action": "hello"
//        },
//        hello: function(action) {
//          alert(action);
//        }
//      });
//
//      new AppRouter();
//      Backbone.history.start();
    </script>
  </body>
</html>
